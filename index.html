<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f0f0f0">
    <title>Eventos by AJRA</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="images/logo.webp">
    <meta name="description" content="EVENTOS by AJRA">
    <meta property="og:title" content="EVENTOS by AJRA">
    <meta property="og:description" content="Calendario de eventos de AJRA">
    <meta property="og:image" content="images/logo.webp">
    <meta property="og:url" content="https://eventos.ajra.es">
    <script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="d475f634-84bb-448f-9a73-b0576d734398"
        async></script>
    <link href="css/eventos.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>

<body>
    <header>
        <a href="https://ajra.es">
            <img src="images/AJRA.webp" alt="AJRA" width="150" height="150" class="avatar">
        </a>
    </header>
    <div class="home">
        <img src="images/logo.webp" alt="AJRA" width="300" height="300" style="border-radius: 8%; margin-bottom: 25px;">
        <h2>Listado de eventos de CULTURAFREAK</h2>
        <a
            href="webcal://calendar.google.com/calendar/ical/84d41ef1a1a31d6e5fa01c477a7b7c5e93ca524098f0474afadac4f50d6fd64e@group.calendar.google.com/public/basic.ics">
            <h2 class="suscribirse">SUSCRIBETE AL CALENDARIO</h2>
        </a>
    </div>
    <div class="filter-buttons">
        <button onclick="filterEvents('todos')" class="botonesfiltro">TODOS</button>
        <button onclick="filterEvents('cineytv')" class="botonesfiltro">CINEYTV</button>
        <button onclick="filterEvents('curiosidades')" class="botonesfiltro">CURIOSIDADES</button>
        <button onclick="filterEvents('deportes')" class="botonesfiltro">DEPORTES</button>
        <button onclick="filterEvents('festividades')" class="botonesfiltro">FESTIVIDADES</button>
        <button onclick="filterEvents('tecnologia')" class="botonesfiltro">TECNOLOG칈A</button>
        <button onclick="filterEvents('videojuegos')" class="botonesfiltro">VIDEOJUEGOS</button>
        <input type="text" id="searchInput" class="buscador" oninput="searchEvents()" placeholder="Buscar evento...">
    </div>
    <div id="events" class="row"></div>
    <footer>
        <script>
            document.write(new Date().getFullYear());
        </script>
        &copy; Desarrollado con 游 & 游눝 por &lt;/AJRA&gt;
    </footer>


    <script>
        // Configuraci칩n de Airtable (Reutilizando credenciales de Marvel/DC)
        const CONFIG = {
            AIRTABLE: {
                TOKEN: 'patv41n63HLpkM4VN.' + 'bbe008721d08d1e969c3398df4550c53a1704b64ed752cc16ae8060a0bd373b3',
                BASE_ID: 'apphXPfmF1OwvCPWC',
                TABLE_NAME: 'eventos',
                // Columna espec칤fica para los filtros de esta web (CINEYTV, DEPORTES, etc.)
                CATEGORY_FIELD: 'CategoriaEvento',

                // Mostrar todos los eventos (Marvel, DC, CulturaFreak)
                // FILTER_FIELD: 'Franquicia',
                // FILTER_VALUE: 'CulturaFreak'
            }
        };

        const eventsContainer = document.getElementById('events');
        const placeholderimagen = 'images/eventos/eventos.webp';
        let allEvents = [];

        // 游늷 Formatea la fecha en formato DD/MM/YYYY
        const formatDate = (date) => {
            return new Intl.DateTimeFormat('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(date);
        };

        // 游늷 Calcula cu치ntos d칤as faltan para el evento
        const calculateDaysRemaining = (eventDate) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eventDay = new Date(eventDate);
            eventDay.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((eventDay - today) / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? `FALTAN ${diffDays} D칈AS` : "HOY";
        };

        // 游늷 Muestra los eventos en la p치gina
        const displayEvents = (events) => {
            eventsContainer.innerHTML = '';

            if (events.length === 0) {
                eventsContainer.innerHTML = '<p style="text-align:center; width:100%; grid-column: 1 / -1; margin-top:2rem;">No se encontraron eventos pr칩ximos.</p>';
                return;
            }

            events.forEach(({ titulo, eventDate, descripcion, imagen, url }) => {
                const card = document.createElement('div');
                card.className = 'card';

                // Solo envolver la imagen en un enlace si existe una URL v치lida
                const imageHtml = url && url.trim() !== ''
                    ? `<a href="${url}" target="_blank">
                        <img src="${imagen}" class="event-image" alt="${titulo}" loading="lazy">
                       </a>`
                    : `<img src="${imagen}" class="event-image" alt="${titulo}" loading="lazy">`;

                card.innerHTML = `
                ${imageHtml}
                <div class="card-body">
                    <h2 class="titulo">${titulo}</h2>
                    <p class="fecha">${formatDate(eventDate)}</p>
                    <div class="faltan-container">
                        <div class="faltan">${calculateDaysRemaining(eventDate)}</div>
                        <button class="calendar-btn" onclick="downloadICS('${titulo.replace(/'/g, "\\'")}', '${eventDate.toISOString()}', '${(descripcion || '').replace(/'/g, "\\'")}')">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>
                </div>`;
                eventsContainer.appendChild(card);
            });
        };

        // 游늷 Obtiene los eventos desde Airtable
        const fetchAirtableEvents = async () => {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Construir URL sin filtro para traer TODO (Marvel, DC, CulturaFreak, etc.)
                // Ordenar por FechaOrden ascendente
                const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE.BASE_ID}/${CONFIG.AIRTABLE.TABLE_NAME}?sort[0][field]=FechaOrden&sort[0][direction]=asc`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.AIRTABLE.TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error Airtable: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                allEvents = data.records.map(record => {
                    const fields = record.fields;
                    const eventDateStr = fields.FechaOrden;
                    if (!eventDateStr) return null;

                    const eventDate = new Date(eventDateStr);
                    const userTimezoneOffset = eventDate.getTimezoneOffset() * 60000;
                    const adjustedDate = new Date(eventDate.getTime() + userTimezoneOffset);

                    return {
                        id: record.id,
                        titulo: fields.Titulo || 'Sin T칤tulo',
                        eventDate: adjustedDate,
                        descripcion: fields.Descripcion || '',
                        imagen: (fields.Imagen && fields.Imagen.length > 0) ? fields.Imagen[0].url : placeholderimagen,
                        // Usamos la nueva columna configurable 'CategoriaEvento'. 
                        // Mantenemos fallback a 'General' si est치 vac칤a.
                        categoria: fields[CONFIG.AIRTABLE.CATEGORY_FIELD] || 'General',
                        url: fields.IMDbURL || fields.URL || ''
                    };
                })
                    .filter(ev => ev !== null && !isNaN(ev.eventDate.getTime()) && ev.eventDate >= today);

                displayEvents(allEvents);

            } catch (error) {
                console.error('Error al cargar eventos desde Airtable:', error);
                eventsContainer.innerHTML = `<p style="text-align:center; color: red; width:100%; grid-column: 1 / -1;">Error cargando eventos: ${error.message}</p>`;
            }
        };

        // 游늷 Filtra eventos por categor칤a
        function filterEvents(categoria) {
            if (!allEvents.length) return;

            const buttons = document.querySelectorAll('.botonesfiltro');

            if (categoria === 'todos') {
                buttons.forEach(button => {
                    button.classList.remove('inactive');
                    button.classList.add('active');
                });
            } else {
                buttons.forEach(button => {
                    button.classList.remove('active');
                    button.classList.add('inactive');
                });
                const activeButton = [...buttons].find(button => button.getAttribute("onclick") === `filterEvents('${categoria}')`);
                if (activeButton) {
                    activeButton.classList.add('active');
                    activeButton.classList.remove('inactive');
                }
            }

            const filteredEvents = categoria === 'todos'
                ? allEvents
                : allEvents.filter(event => event.categoria && event.categoria.toLowerCase() === categoria.toLowerCase());

            displayEvents(filteredEvents);
        };

        // 游늷 Busca eventos por t칤tulo o descripci칩n
        function searchEvents() {
            const searchString = document.getElementById('searchInput').value.toLowerCase();

            const filteredEvents = allEvents.filter(event =>
                (event.titulo ? event.titulo.toLowerCase().includes(searchString) : false) ||
                (event.descripcion ? event.descripcion.toLowerCase().includes(searchString) : false)
            );

            displayEvents(filteredEvents);
        }

        // 游늷 Genera y descarga archivo ICS para calendario
        function downloadICS(titulo, fechaISO, descripcion) {
            const eventDate = new Date(fechaISO);

            const formatDateForICS = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            };

            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            const cleanText = (text) => {
                return text.replace(/[^\w\s]/gi, '').replace(/\n/g, '\\n').replace(/,/g, '\\,');
            };

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CULTURAFREAK//EVENTOS//ES
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${timestamp}-culturafreak@ajra.es
DTSTART;VALUE=DATE:${formatDateForICS(eventDate)}
SUMMARY:${cleanText(titulo)}
DESCRIPTION:${cleanText(descripcion || 'Evento de CULTURAFREAK')}
ORGANIZER;CN=CULTURAFREAK:MAILTO:eventos@ajra.es
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `${cleanText(titulo)}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(link.href);
        }

        // Inicializar la aplicaci칩n cuando el DOM est칠 cargado
        document.addEventListener("DOMContentLoaded", function () {
            fetchAirtableEvents();
            document.getElementById("searchInput").addEventListener("input", searchEvents);
        });

    </script>
</body>

</html>