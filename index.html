<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos by AJRA</title>
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="img/eventos.png">
    <meta name="description" content="EVENTOS by AJRA">
    <meta property="og:title" content="EVENTOS by AJRA">
    <meta property="og:description" content="Calendario de eventos de AJRA">
    <meta property="og:image" content="img/eventos.png">
    <meta property="og:url" content="https://eventos.ajra.es">
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
    }

    .home {
        justify-content: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 50px;
    }

    .home h1,
    .home h2 {
        text-align: center;
        margin: 5px;
    }

    h2 {
        font-size: 1rem;
        font-weight: normal;
    }

    .avatar {
        max-width: 75px;
        height: auto;
        padding: 2rem;
        border-radius: 50%;
        transition: transform 0.2s ease-in-out;
    }

    .avatar:hover {
        transform: scale(1.05);
    }

    .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin: 1rem;
        box-sizing: border-box;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .card img {
        max-width: 100%;
        height: auto;
    }

    .card-body {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .titulo {
        font-weight: 700;
        font-size: 1.3rem;
        margin: 0;
        margin-bottom: 0.5rem;
    }

    .fecha {
        color: #757575;
        font-size: 0.875rem;
        padding-bottom: 0.75rem;
        margin-top: 0;
    }

    .descripcion {
        color: #0a0a0a;
        margin-bottom: 0.75rem;
        font-size: 1rem;
        flex: 1;
    }

    .row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 5px;
    }

    .faltan-container {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        gap: 7px;
    }

    .faltan {
        display: inline-block;
        background-color: rgb(108, 41, 240);
        font-size: 0.875rem;
        color: white;
        padding: 0.65rem;
        border-radius: 0.5rem;
        text-align: center;
    }

    .iCal {
        display: inline-block;
        background-color: rgb(108, 41, 240);
        font-size: 0.875rem;
        color: white;
        padding: 0.65rem;
        border-radius: 0.5rem;
        text-align: center;
        min-width: 15px;
        transition: transform 0.2s ease-in-out;
    }

    .iCal:hover {
        transform: scale(1.05);
    }


    footer {
        text-align: center;
        font-size: 13px;
        line-height: 2rem;
        margin-top: 4rem;
    }

    .suscribirse {
        display: inline-block;
        background-color: rgb(108, 41, 240);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        text-decoration: none;
        margin-top: 1rem;
        text-transform: uppercase;
    }

    .suscribirse:hover {
        background-color: rgb(80, 30, 180);
    }
</style>

<body>
    <header>
        <a href="https://ajra.es">
            <img src="img/AJRA.webp" alt="AJRA" class="avatar">
        </a>
    </header>
    <div class="home">
        <img src="https://softr-prod.imgix.net/applications/e89e50a1-9317-4b59-bd24-88dc2dd834d6/assets/67a66ffd-83cb-48d4-9ddf-01399be3cf7c.svg"
            alt="AJRA">
        <h1>CALENDARIO DE EVENTOS</h1>
        <h2>Listado de eventos de interes para AJRA</h2>
    </div>
    <div id="events" class="row"></div>
    <footer>2023 &copy; Desarrollado con 🧠 & 💛 por <a href="https://ajra.es"
            style="text-decoration: none; color: black"> &lt;/AJRA&gt; </a></footer>
</body>
</html>

<script>
    const SPREADSHEET_ID = '1bjuRsUCQLT_MwgKQ9GR7gPHJyYq339v-JHM_ErPbGjI';
    const API_KEY = 'AIzaSyBVknxjJb5j7AFLBrltXfOptE1xWweeGJ0';
    const eventsContainer = document.getElementById('events');

    const formatDate = (date) => {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric'};
        const eventDate = new Date(date);
        if (isNaN(eventDate.getTime()) || eventDate.getHours() === 0 && eventDate.getMinutes() === 0) {
            options.hour = undefined;
            options.minute = undefined;
        }
        return eventDate.toLocaleString('es', options);
    };

    const createEventCard = (summary, start, description, imageUrl, daysRemainingText, duration) => {
        const card = document.createElement('div');
        card.className = 'card';

        const imageElement = document.createElement('img');
        imageElement.className = 'event-image';
        imageElement.src = imageUrl;
        imageElement.alt = summary;
        card.appendChild(imageElement);

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const eventTitle = document.createElement('h2');
        eventTitle.className = 'titulo';
        eventTitle.textContent = summary;

        const eventDate = document.createElement('p');
        eventDate.className = 'fecha';
        eventDate.textContent = formatDate(start);

        const eventDescription = document.createElement('p');
        eventDescription.className = 'descripcion';
        eventDescription.textContent = description;

        const eventDuration = document.createElement('p');
        eventDuration.className = 'duracion';
        eventDuration.textContent = `Duración: ${duration} minutos`;

        const container = document.createElement('div');
        container.className = 'ical-container';

        const daysRemainingContainer = document.createElement('div');
        daysRemainingContainer.className = 'faltan-container';

        const daysRemainingElement = document.createElement('p');
        daysRemainingElement.className = 'faltan';
        daysRemainingElement.textContent = daysRemainingText;

        const generateICalButton = document.createElement('p');
        generateICalButton.className = 'iCal';
        generateICalButton.textContent = '+';
        generateICalButton.addEventListener('click', () => {
            generateICalFile(summary, start, description, duration);
        });

        daysRemainingContainer.appendChild(daysRemainingElement);
        daysRemainingContainer.appendChild(generateICalButton);

        [eventTitle, eventDate, eventDescription, daysRemainingContainer].forEach(element => cardBody.appendChild(element));
        card.appendChild(cardBody);
        return card;
    };

    const generateICalFile = (summary, startDate, description, duration) => {
        const startDateObject = new Date(startDate);
        const endDateObject = new Date(startDateObject.getTime() + duration * 60000); // Calcula la fecha de finalización en milisegundos

        const startDateFormatted = startDateObject.toISOString().replace(/[:-]/g, '').split('.')[0] + 'Z';
        const endDateFormatted = endDateObject.toISOString().replace(/[:-]/g, '').split('.')[0] + 'Z';

        const fileName = `${summary}.ics`;
        const iCalContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${summary}
DTSTART:${startDateFormatted}
DTEND:${endDateFormatted}
DESCRIPTION:${description}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([iCalContent], { type: 'text/calendar' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    };

    const placeholderImageUrl = 'img/eventos.png';
    const fetchGoogleSheetEvents = () => {
        const now = new Date();
        const apiKeyParam = `key=${API_KEY}`;
        const sheetRange = 'Eventos!A2:F'; // Agrega una columna para la duración
        const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetRange}?${apiKeyParam}`;

        fetch(sheetUrl)
            .then(response => response.json())
            .then(data => {
                const rows = data.values || [];
                const events = [];
                rows.forEach(row => {
                    const [summary, dateString, description, imageFilename, durationString] = row;
                    const imageUrl = imageFilename ? `img/${imageFilename}` : placeholderImageUrl;
                    let eventDate = new Date(dateString);
                    let duration = parseInt(durationString) || 60; // Duración predeterminada de 1 hora en minutos

                    // Verificar si eventDate es válido, y si no, establecerlo en 8:00 am del mismo día.
                    if (isNaN(eventDate.getTime())) {
                        eventDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0);
                    }

                    // Establecer la hora en 8:00 am si no se proporciona una hora válida.
                    if (eventDate.getHours() === 0 && eventDate.getMinutes() === 0) {
                        eventDate.setHours(8, 0, 0);
                    }

                    if (eventDate >= now) {
                        events.push({ summary, eventDate, description, imageUrl, duration });
                    }
                });
                events.sort((a, b) => a.eventDate - b.eventDate);
                events.forEach(event => {
                    const daysRemaining = Math.ceil((event.eventDate - now) / (1000 * 60 * 60 * 24));
                    const daysRemainingText = `FALTAN ${daysRemaining} DÍAS`;
                    const eventCard = createEventCard(event.summary, event.eventDate, event.description, event.imageUrl, daysRemainingText, event.duration);
                    eventsContainer.appendChild(eventCard);
                });
            })
            .catch(error => console.error('Error:', error));
    };

    fetchGoogleSheetEvents();
</script>