<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#f0f0f0">
    <title>Eventos by AJRA</title>
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="img/AJRA.webp">
    <meta name="description" content="EVENTOS by AJRA">
    <meta property="og:title" content="EVENTOS by AJRA">
    <meta property="og:description" content="Calendario de eventos de AJRA">
    <meta property="og:image" content="img/eventos.png">
    <meta property="og:url" content="https://eventos.ajra.es">
    <script src="https://beamanalytics.b-cdn.net/beam.min.js" data-token="d475f634-84bb-448f-9a73-b0576d734398" async></script>
    <link href="style.css" rel="stylesheet" type="text/css">
</head>

<body>
    <header>
        <a href="https://ajra.es">
            <img src="img/AJRA.webp" alt="AJRA" class="avatar">
        </a>
    </header>
    <main>
        <section class="home">
            <img src="img/logo.png" alt="AJRA" style="border-radius: 50%; margin-bottom: 25px;">
            <h1>CALENDARIO DE EVENTOS</h1>
            <h2>Listado de eventos de inter√©s para AJRA</h2>
            <a href="https://news.ajra.es">
                <h2 class="suscribirse">SUSCR√çBETE</h2>
            </a>
        </section>
        <section class="filter-buttons">
            <button onclick="filterEvents('todos')" class="botonesfiltro">TODOS</button>
            <button onclick="filterEvents('cineytv')" class="botonesfiltro">CINE Y TV</button>
            <button onclick="filterEvents('curiosidades')" class="botonesfiltro">CURIOSIDADES</button>
            <button onclick="filterEvents('deportes')" class="botonesfiltro">DEPORTES</button>
            <button onclick="filterEvents('festividades')" class="botonesfiltro">FESTIVIDADES</button>
            <button onclick="filterEvents('tecnologia')" class="botonesfiltro">TECNOLOG√çA</button>
            <button onclick="filterEvents('videojuegos')" class="botonesfiltro">VIDEOJUEGOS</button>
            <input type="text" id="searchInput" class="buscador" oninput="searchEvents()" placeholder="Buscar evento...">
        </section>
        <section id="events" class="row"></section>
    </main>
    <footer>
        <p>2023 &copy; Desarrollado con üß† & üíõ por <a href="https://ajra.es" style="text-decoration: none; color: black"> &lt;/AJRA&gt; </a></p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <script>
        const SPREADSHEET_ID = '1bjuRsUCQLT_MwgKQ9GR7gPHJyYq339v-JHM_ErPbGjI';
        const API_KEY = 'AIzaSyBVknxjJb5j7AFLBrltXfOptE1xWweeGJ0';
        const eventsContainer = document.getElementById('events');
        const placeholderImagen = 'img/eventos.png';

        let allEvents = [];

        const formatDate = date => moment(date).format('DD/MM/YYYY');

        const createEventCard = ({ titulo, eventDate, descripcion, imagen, url }) => {
            const today = moment.tz(moment.tz.guess()).startOf('day');
            const eventMoment = moment.tz(eventDate, moment.tz.guess());
            const daysRemaining = eventMoment.diff(today, 'days');
            const diasFaltan = `FALTAN ${daysRemaining} D√çAS`;

            const card = document.createElement('article');
            card.className = 'card';

            const imageElement = document.createElement('img');
            imageElement.className = 'event-image';
            imageElement.src = imagen || placeholderImagen;
            imageElement.alt = titulo;

            if (url) {
                const linkElement = document.createElement('a');
                linkElement.href = url;
                linkElement.target = '_blank';
                linkElement.appendChild(imageElement);
                card.appendChild(linkElement);
            } else {
                card.appendChild(imageElement);
            }

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const eventTitle = document.createElement('h2');
            eventTitle.className = 'titulo';
            eventTitle.textContent = titulo;

            const eventDateElement = document.createElement('p');
            eventDateElement.className = 'fecha';
            eventDateElement.textContent = formatDate(eventDate);

            const eventDescription = document.createElement('p');
            eventDescription.className = 'descripcion';
            eventDescription.textContent = descripcion;

            const daysRemainingContainer = document.createElement('div');
            daysRemainingContainer.className = 'faltan-container';

            const daysRemainingElement = document.createElement('p');
            daysRemainingElement.className = 'faltan';
            daysRemainingElement.textContent = diasFaltan;
            daysRemainingContainer.appendChild(daysRemainingElement);

            [eventTitle, eventDateElement, eventDescription, daysRemainingContainer].forEach(element => cardBody.appendChild(element));

            card.appendChild(cardBody);

            return card;
        };

        const fetchGoogleSheetEvents = async () => {
            try {
                const now = moment.tz(moment.tz.guess()).startOf('day').toDate();
                const sheetRange = 'Eventos!A2:F';
                const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetRange}?key=${API_KEY}`;

                const response = await fetch(sheetUrl);
                const data = await response.json();

                const rows = data.values || [];
                allEvents = rows
                    .map(row => {
                        const [titulo, dateString, descripcion, imageUrl, categoriaRow, url] = row;
                        const eventDate = moment(dateString, 'DD/MM/YYYY').toDate();
                        return !isNaN(eventDate.getTime()) && eventDate >= now
                            ? { titulo, eventDate, descripcion, imagen: imageUrl || placeholderImagen, categoria: categoriaRow, url }
                            : null;
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.eventDate - b.eventDate);

                displayEvents(allEvents);
            } catch (error) {
                console.error('Error:', error);
            }
        };

        const displayEvents = (events) => {
            eventsContainer.innerHTML = '';
            events.forEach(event => {
                eventsContainer.appendChild(createEventCard(event));
            });
        };

        const filterEvents = (categoria) => {
            document.querySelectorAll('.botonesfiltro').forEach(button => {
                button.classList.toggle('inactive', categoria !== 'todos' && !button.textContent.toLowerCase().includes(categoria));
            });

            const filteredEvents = categoria === 'todos' ? allEvents : allEvents.filter(event => event.categoria === categoria);
            displayEvents(filteredEvents);
        };

        const searchEvents = () => {
            const searchString = document.getElementById('searchInput').value.toLowerCase();

            const filteredEvents = allEvents.filter(event =>
                (event.titulo?.toLowerCase().includes(searchString) || false) ||
                (event.descripcion?.toLowerCase().includes(searchString) || false)
            );

            displayEvents(filteredEvents);
        };

        fetchGoogleSheetEvents();
    </script>
</body>

</html>